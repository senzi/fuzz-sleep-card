<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‘›ç±³å¦®ç¡çœ åˆ†æå°å¡ç‰‡ Pro</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <script src="https://unpkg.com/@zumer/snapdom/dist/snapdom.js"></script>
    
    <style>
        @import url('https://fonts.loli.net/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');

        :root {
            --primary: #4b4b4b;
            --primary-light: #6f6f6f;
            --bg: #f0f0f0;
            --card-bg: #ffffff;
            --text-main: #1f1f1f;
            --text-light: #8c8c8c;
            --good: #5a5a5a;
            --bad: #3c3c3c;
            --neutral: #7a7a7a;
        }

        body {
            font-family: 'Noto Sans SC', 'Noto Sans CJK SC', -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* --- å¡ç‰‡ä¸»ä½“ --- */
        .card {
            width: 400px;
            background: linear-gradient(145deg, #ffffff, #f7f7f7);
            border-radius: 24px;
            /* è¿™é‡Œçš„ box-shadow åªåœ¨ç½‘é¡µå±•ç¤ºæ—¶æœ‰æ•ˆï¼Œsnapdom æˆªå›¾æ—¶å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½†é€šå¸¸ä¸æˆªå–å¤–éƒ¨é˜´å½±æ›´å¹²å‡€ */
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
            overflow: hidden;
            position: relative;
        }

        .card-header {
            background: linear-gradient(135deg, #2b2b2b, #555);
            color: #f7f7f7;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h2 { margin: 0; font-size: 28px; letter-spacing: 0.5px; }
        .header-info p { margin: 5px 0 0 0; opacity: 0.8; font-size: 13px; letter-spacing: 1px;}
        .header-info .source { margin: 8px 0 0 0; font-size: 12px; opacity: 0.75; letter-spacing: 0.5px; }
        
        .header-badge {
            background: rgba(255,255,255,0.16);
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.6px;
            backdrop-filter: blur(5px);
            color: #f2f2f2;
        }

        .metrics-list {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .metric-row {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 16px;
            padding: 12px 15px;
        }
        
        .m-icon {
            width: 40px;
            height: 40px;
            background: #fbfbfb;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            flex-shrink: 0;
        }

        .m-content { flex-grow: 1; }
        
        .m-top {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .m-label { font-size: 12px; color: var(--text-light); font-weight: bold;}
        .m-value { font-size: 18px; font-weight: bold; color: var(--text-main); }

        .m-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .m-comment {
            font-size: 11px;
            color: var(--primary);
            opacity: 0.8;
            font-weight: 500;
        }

        .trend-pill {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .trend-good { background: rgba(90, 90, 90, 0.08); color: var(--good); }
        .trend-bad { background: rgba(60, 60, 60, 0.08); color: var(--bad); }
        .trend-flat { background: rgba(122, 122, 122, 0.1); color: var(--neutral); }
        .trend-arrow { font-weight: 700; }
        .trend-arrow.up { color: #2f9a3b; }
        .trend-arrow.down { color: #d64545; }

        .gemini-box {
            margin: 0 20px 25px 20px;
            background: #f6f6f6;
            border-radius: 16px;
            padding: 15px;
            position: relative;
            border-left: 4px solid var(--primary);
        }

        .gemini-title {
            font-size: 12px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .gemini-text {
            font-size: 13px;
            line-height: 1.6;
            color: #3a3a3a;
            text-align: justify;
        }

        .footer {
            text-align: center;
            padding-bottom: 15px;
            font-size: 10px;
            color: #9c9c9c;
            letter-spacing: 0.4px;
        }

        .gemini-mark {
            position: absolute;
            right: 32px;
            bottom: 32px;
            width: 32px;
            height: 32px;
        }
        .gemini-mark img,
        .gemini-mark svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* --- æŒ‰é’®æ ·å¼ --- */
        .controls { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .controls-row { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
        .btn {
            padding: 10px 24px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.18); }
        .btn-sub { background: white; color: var(--text-main); }
        .btn-sub:hover { transform: translateY(-2px); }
        
        /* ä¸‹è½½æŒ‰é’®ç‰¹æ®Šé¢œè‰² */
        .btn-download { background: #2d2d2d; color: white; }
        .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.25); }
        .btn-ghost { box-shadow: none; border: 1px solid #eee; }

        .copy-toast {
            font-size: 12px;
            color: #2d2d2d;
            background: #f2f2f2;
            padding: 6px 10px;
            border-radius: 999px;
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-height: 20px;
        }
        .copy-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
            z-index: 999;
        }
        .modal-wrap.active { opacity: 1; visibility: visible; }
        .modal { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 20px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-family: monospace; resize: vertical; margin: 15px 0; box-sizing: border-box;}
        textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
    </style>
</head>
<body>

        <div class="card" id="card">
        <div class="card-header">
            <div class="header-info">
                <h2 id="disp-day">Day 14</h2>
                <p id="disp-date">2025.12.26 / Friday</p>
                <p class="source">æ•°æ®æ¥æºï¼šAutoSleep</p>
            </div>
            <div class="header-badge">è‘›ç±³å¦®ç¡çœ åˆ†æ</div>
        </div>

        <div class="metrics-list" id="metrics-container"></div>

        <div class="gemini-box">
            <div class="gemini-title">âœ¨ è‘›ç±³å¦®åˆ†æ</div>
            <div class="gemini-text" id="disp-comment">Waiting for data...</div>
        </div>

        <div class="footer">ç”±è‘›ç±³å¦®åˆ†æç”Ÿæˆ</div>
        <div class="gemini-mark" id="gemini-mark">
            <img class="gemini-mark-img" src="gemini-color.svg" alt="Gemini">
        </div>
    </div>

    <div class="controls">
        <div class="controls-row">
            <button class="btn btn-sub" onclick="copyTemplate()">ğŸ“‹ å¤åˆ¶ JSON æ¨¡æ¿</button>
            <button class="btn btn-main" onclick="openModal()">âœï¸ å¡«å…¥ä»Šæ—¥æ•°æ®</button>
            <button class="btn btn-download" onclick="downloadImage()">ğŸ“¸ ä¿å­˜ä¸ºå›¾ç‰‡</button>
        </div>
        <span class="copy-toast" id="copy-toast" role="status" aria-live="polite"></span>
    </div>

    <div class="modal-wrap" id="modal">
        <div class="modal">
            <h3 style="margin-top:0;">è¾“å…¥æ•°æ® JSON</h3>
            <textarea id="json-input" placeholder="è¯·ç²˜è´´ Gemini ç»™ä½ çš„ JSON ä»£ç ..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-sub btn-ghost" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-main" onclick="renderCard()">ç”Ÿæˆå¡ç‰‡</button>
            </div>
        </div>
    </div>

    <script>
        // å½“å‰æ•°æ®çŠ¶æ€ï¼Œç”¨äºç”Ÿæˆæ–‡ä»¶å
        let currentDayVal = "14";

        // é»˜è®¤å ä½æ•°æ®
        const defaultData = {
            "day": "00",
            "date": "YYYY.MM.DD",
            "metrics": [
                {
                    "icon": "ğŸ›Œ", "label": "ç¡çœ æ•ˆç‡", "value": "00.0%", 
                    "trend": "up", "status": "good", "diff": "0.0%", "comment": "æ•°æ®çŠ¶æ€ç®€è¯„"
                },
                {
                    "icon": "ğŸŒŠ", "label": "æ·±åº¦ç¡çœ ", "value": "00:00", 
                    "trend": "up", "status": "good", "diff": "+0h00m", "comment": "æ·±åº¦ç¡çœ é˜¶æ®µåˆ†æ"
                },
                {
                    "icon": "â¤ï¸", "label": "å¹³å‡å¿ƒç‡", "value": "00 bpm", 
                    "trend": "down", "status": "good", "diff": "-0.0", "comment": "é™æ¯å¿ƒç‡å¥åº·åº¦"
                },
                {
                    "icon": "âš¡", "label": "HRV", "value": "00 ms", 
                    "trend": "up", "status": "good", "diff": "+0 ms", "comment": "èº«ä½“æ¢å¤èƒ½åŠ›æŒ‡æ ‡"
                },
                {
                    "icon": "â³", "label": "æ€»ç¡çœ ", "value": "00:00", 
                    "trend": "flat", "status": "neutral", "diff": "0m", "comment": "æ—¶é•¿æ˜¯å¦è¾¾æ ‡"
                }
            ],
            "overall": "è¿™é‡Œæ˜¯æ¥è‡ª Gemini çš„æ·±åº¦åˆ†æç®€è¿°ã€‚å®ƒå°†æ ¹æ®ä¸Šè¿°æ•°æ®ä¸ºä½ æä¾›ä¸ªæ€§åŒ–çš„ç¡çœ å»ºè®®ã€å¿ƒç†çŠ¶æ€è§‚å¯Ÿä»¥åŠé’ˆå¯¹æ€§çš„å¥åº·æé†’ wã€‚"
        };

        function render(data) {
            currentDayVal = data.day; // æ›´æ–°å¤©æ•°ä¾›ä¸‹è½½ä½¿ç”¨
            document.getElementById('disp-day').innerText = `Day ${data.day}`;
            document.getElementById('disp-date').innerText = data.date;
            document.getElementById('disp-comment').innerText = data.overall;

            const container = document.getElementById('metrics-container');
            container.innerHTML = ''; 

            data.metrics.forEach(m => {
                let arrow = m.trend === 'up' ? 'â–²' : (m.trend === 'down' ? 'â–¼' : '-');
                let arrowClass = m.trend === 'up' ? 'up' : (m.trend === 'down' ? 'down' : 'flat');
                let trendClass = m.status === 'good' ? 'trend-good' : (m.status === 'bad' ? 'trend-bad' : 'trend-flat');

                const html = `
                <div class="metric-row">
                    <div class="m-icon">${m.icon}</div>
                    <div class="m-content">
                        <div class="m-top">
                            <span class="m-label">${m.label}</span>
                            <div class="trend-pill ${trendClass}"><span class="trend-arrow ${arrowClass}">${arrow}</span> ${m.diff}</div>
                        </div>
                        <div class="m-bottom">
                            <span class="m-value">${m.value}</span>
                            <span class="m-comment">${m.comment}</span>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
        // Snapdom download
        async function downloadImage() {
            const cardElement = document.getElementById('card');
            const cleanupGemini = await inlineGeminiMark();

            try {
                await snapdom.download(cardElement, {
                    filename: `Gemini_Sleep_Day_${currentDayVal}`,
                    format: 'png',
                    scale: 2 
                });
                console.log('Image saved!');
            } catch (err) {
                console.error('Snapdom error:', err);
                alert('\u4fdd\u5b58\u56fe\u7247\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\u6216\u624b\u52a8\u622a\u56fe>_<');
            } finally {
                if (cleanupGemini) cleanupGemini();
            }
        }

        render(defaultData);

        const modal = document.getElementById('modal');
        const input = document.getElementById('json-input');
        const copyToast = document.getElementById('copy-toast');
        let copyToastTimer = null;

        function openModal() {
            modal.classList.add('active');
            if(!input.value) input.value = JSON.stringify(defaultData, null, 4);
        }
        function closeModal() { modal.classList.remove('active'); }
        function renderCard() {
            try {
                const data = JSON.parse(input.value);
                render(data);
                closeModal();
            } catch (e) { alert('JSON æ ¼å¼æœ‰è¯¯: ' + e.message); }
        }
        function showCopyToast(message) {
            if (!copyToast) return;
            copyToast.textContent = message;
            copyToast.classList.add('show');
            clearTimeout(copyToastTimer);
            copyToastTimer = setTimeout(() => {
                copyToast.classList.remove('show');
            }, 1600);
        }
        function copyTemplate() {
            navigator.clipboard.writeText(JSON.stringify(defaultData, null, 4)).then(() => {
                showCopyToast('\u5df2\u590d\u5236 JSON \u6a21\u677f');
            }).catch(() => {
                showCopyToast('\u590d\u5236\u5931\u8d25\uff0c\u8bf7\u624b\u52a8\u590d\u5236');
            });
        }
        async function inlineGeminiMark() {
            const container = document.getElementById('gemini-mark');
            if (!container) return null;
            if (container.querySelector('svg')) return null;

            const img = container.querySelector('img');
            const src = img ? img.getAttribute('src') : 'gemini-color.svg';
            if (!src) return null;

            try {
                const response = await fetch(src, { cache: 'force-cache' });
                if (!response.ok) throw new Error('fetch failed');
                const svgText = await response.text();
                container.insertAdjacentHTML('afterbegin', svgText);

                const svg = container.querySelector('svg');
                if (svg) {
                    svg.setAttribute('width', '100%');
                    svg.setAttribute('height', '100%');
                }
                if (img) img.style.visibility = 'hidden';

                return () => {
                    if (svg && svg.parentNode === container) svg.remove();
                    if (img) img.style.visibility = '';
                };
            } catch (err) {
                console.warn('Failed to inline gemini mark:', err);
                return null;
            }
        }


        modal.addEventListener('click', (e) => {
            if(e.target === modal) closeModal();
        });
        inlineGeminiMark();
    </script>
</body>
</html>
